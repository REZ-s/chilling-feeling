<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      xmlns:th="http://www.thymeleaf.org">
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta content="IE=edge" http-equiv="X-UA-Compatible">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title> Chilling Feeling - Login (1/2) </title>

    <!-- CSS -->
    <link href="/css/cf_style.css" rel="stylesheet" type="text/css">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
    <style>
        /* For modal */
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR&display=swap');

        .modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
        }

        @media screen and (min-width: 768px) {
            .modal:before {
                display: inline-block;
                vertical-align: middle;
                content: " ";
                height: 100%;
            }
        }

        .modal-dialog {
            display: inline-block;
            text-align: left;
            vertical-align: middle;
        }

        .modal-content {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            border-radius: 10px;
            background-color: #262626;
        }

        .popup {
            width: 335px;
            height: 143px;
            flex-grow: 0;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            align-items: flex-end;
            gap: 10px;
            padding: 20px;
            border-radius: 10px;
            background-color: #262626;
        }

        .error_message {
            height: 65px;
            align-self: stretch;
            flex-grow: 0;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            align-items: stretch;
            gap: 5px;
            padding: 0;
        }

        .text1 {
            height: 32px;
            align-self: stretch;
            flex-grow: 0;
            font-family: 'Noto Sans KR', serif;
            font-size: 22px;
            font-weight: bold;
            font-stretch: normal;
            font-style: normal;
            line-height: 1.45;
            letter-spacing: -0.44px;
            text-align: left;
            color: #fff;
        }

        .text2 {
            height: 28px;
            align-self: stretch;
            flex-grow: 0;
            font-family: 'Noto Sans KR', serif;
            font-size: 16px;
            font-weight: 500;
            font-stretch: normal;
            font-style: normal;
            line-height: 1.75;
            letter-spacing: -0.32px;
            text-align: left;
            color: #fff;
        }

        .laber {
            width: 90px;
            height: 28px;
            flex-grow: 0;
            font-family: 'Noto Sans KR', serif;
            font-size: 16px;
            font-weight: 500;
            font-stretch: normal;
            font-style: normal;
            line-height: 1.75;
            letter-spacing: -0.32px;
            text-align: left;
            color: #035064;
        }

    </style>
</head>
<body>
<div class="login1">
    <!-- Top Frame -->
    <section class="login2-header">
        <div class="ic_back_24px">
            <a href="/main">
                <img src="/images/ic_back_24px.png">
            </a>
        </div>
        <div class="login2-content">
            <span class="login2-headline-text">로그인</span>
        </div>
        <div class="ic_close_24px">
            <a href="/main">
                <img src="/images/ic_close_24px.png">
            </a>
        </div>
    </section>

    <!-- Content Frame -->
    <div class="login1-title-area">
        <div class="login1-title">
            <span>내 취향이 가득 담긴 술을 확인 해볼까요?</span>
        </div>
        <div class="login1-subtitle">
            <span>먼저 로그인이 필요해요:)</span>
        </div>
    </div>

    <form>
        <div class="login1-form-field">
            <input class="login1-form" type="email" placeholder="이메일 주소 입력" id="myEmail">
        </div>

        <button class="login1-play" type="button" id="myBtn">
            <span class="login2-btn-text">계속하기</span>
        </button>
    </form>

    <div class="login1-sub-content-area">
        <div class="login1-email-join-text" >
            이메일 가입
        </div>
        <div class="login1-tiny-line">
        </div>
        <div class="login1-email-join-text">
            이메일 찾기
        </div>
        <div class="login1-tiny-line">
        </div>
        <div class="login1-pw-find-text" >
            비밀번호 찾기
        </div>
    </div>

    <div class="login1-simple-login">
        <div class="login1-simple-login-text-line"></div>
        <span class="login1-simple-login-text">간편 로그인</span>
        <div class="login1-simple-login-text-line"></div>
    </div>

    <div class="logo-btn-area">
        <div class="logo-btn-group">
            <div class="simple-logo1">
                <a href="/oauth2/authorization/kakao">
                    <img src="/images/logo-kakaotalk.png">
                </a>
            </div>
            <div class="simple-logo2">
                <a href="/oauth2/authorization/naver">
                    <img src="/images/logo-naver.png">
                </a>
            </div>
            <div class="simple-logo3">
                <a href="/oauth2/authorization/google">
                    <img src="/images/logo-google.png">
                </a>
            </div>
        </div>
    </div>

    <!-- Modal -->
    <div class="modal fade" id="invalid" role="dialog">
        <div class="modal-dialog">

            <!-- Modal content-->
            <div class="modal-content">
                <div class="modal-body popup" >
                    <div class="error_message">
                        <div class="text1">존재하지 않는 이메일 입니다.</div>
                        <div class="text2">회원가입을 진행할까요?</div>
                    </div>
                    <div class="laber">
                        <a href="/cf_join_page">회원가입 하기</a>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <!-- Modal -->
    <div class="modal fade" id="incorrect" role="dialog">
        <div class="modal-dialog">

            <!-- Modal content-->
            <div class="modal-content">
                <div class="modal-body popup" >
                    <div class="error_message">
                        <div class="text1">간편 로그인으로<br>가입된 이메일 입니다.</div>
                        <br><br>
                        <div class="text2">아래 소셜 아이콘으로 로그인해주세요.</div>
                    </div>
                </div>
            </div>

        </div>
    </div>


</div>
<script src="js/script.js">
    document.addEventListener("DOMContentLoaded", function() {
        const myBtn = document.querySelector("#myBtn");

        myBtn.addEventListener("click", function() {
            const email = document.querySelector("#myEmail").value;
            validateAndSend(email);

            function validateEmail(email) {
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                return emailRegex.test(email);
            }

            async function checkEmailExists(email) {
                try {
                    const response = await fetch('/check_email', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: email
                    });

                    if (response.ok) {
                        return await response.text();
                    }
                    throw response;
                } catch (error) {
                    throw error;
                }
            }

            async function validateAndSend(email) {
                if (!validateEmail(email)) {
                    console.log('Invalid email format');
                    return;
                }

                try {
                    const data = await checkEmailExists(email);
                    if (data === "valid-correct-access") {
                        sendEmailByForm('/cf_login2', email);
                    } else if (data === "valid-incorrect-access") {
                        $("#incorrect").modal();
                    } else {
                        $("#invalid").modal();
                    }
                } catch (error) {
                    console.log('Error checking email exists:', error);
                }
            }

        });
    });
</script>
</body>
</html>